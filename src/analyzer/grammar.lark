%ignore /[ \t\f\r]+/
%ignore /\n+/
%ignore COMMENT

LPAR: "("
RPAR: ")"
LSQB: "["
RSQB: "]"
COMMA: ","
SEMI: ";"
COLON: ":"
ASSIGN: ":="
PLUS: "+"
MINUS: "-"
MUL: "*"
DIV: "/"
EQ: "="
LT: "<"
GT: ">"
LE: "<="
GE: ">="
ARROW: "<-"

PROCEDURE: "PROCEDURE"
BEGINKW: "BEGIN"
ENDKW: "END"
IFKW: "IF"
THENKW: "THEN"
ELSEKW: "ELSE"
FORKW: "FOR"
TOWK: "TO"
DOKW: "DO"
WHILEKW: "WHILE"
REPEATKW: "REPEAT"
UNTILKW: "UNTIL"
RETURNKW: "RETURN"
CALLKW: "CALL"

COMMENT: "â–º" /[^\n]*/
%ignore /\/\/[^\n]*/

%import common.CNAME -> IDENTIFIER
%import common.INT -> NUMBER
%import common.WS_INLINE

start: program

program: (routine)*

routine: PROCEDURE IDENTIFIER "(" param_list? ")" block

param_list: param (COMMA param)*
param: IDENTIFIER

block: BEGINKW stmt_list ENDKW

stmt_list: (statement)*

statement: simple_stmt
         | compound_stmt

simple_stmt: assign_stmt SEMI
           | return_stmt SEMI
           | call_stmt SEMI
           | SEMI

assign_stmt: lvalue ASSIGN expr

lvalue: IDENTIFIER (indexing)*
      | field_access

field_access: IDENTIFIER "." IDENTIFIER

call_stmt: CALLKW IDENTIFIER "(" arg_list? ")"

arg_list: expr (COMMA expr)*

return_stmt: RETURNKW expr?

compound_stmt: if_stmt
             | for_stmt
             | while_stmt
             | repeat_stmt
             | block

if_stmt: IFKW expr THENKW stmt_list (ELSEKW stmt_list)? ENDKW

for_stmt: FORKW IDENTIFIER ASSIGN expr TOWK expr DOKW stmt_list ENDKW

while_stmt: WHILEKW expr DOKW stmt_list ENDKW

repeat_stmt: REPEATKW stmt_list UNTILKW expr SEMI?

?expr: expr_or

?expr_or: expr_or "or" expr_and  -> or_expr
        | expr_and

?expr_and: expr_and "and" expr_cmp -> and_expr
         | expr_cmp

?expr_cmp: arith ((">" | "<" | ">=" | "<=" | "=") arith)?

?arith: arith ("+" | "-") term   -> binop
      | term

?term: term ("*" | "/") factor   -> binop
     | factor

?factor: unary
       | atom

unary: "-" factor -> neg
     | "+" factor -> pos

?atom: NUMBER
     | call_expr
     | array_expr
     | var
     | "(" expr ")"

call_expr: IDENTIFIER function_call
array_expr: IDENTIFIER indexing+
var: IDENTIFIER

function_call: "(" arg_list? ")"
indexing: "[" expr "]"

%ignore WS_INLINE
