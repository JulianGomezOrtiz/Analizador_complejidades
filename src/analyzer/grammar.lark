// ==========================================
// GRAMÃTICA PASCAL-LIKE (CORREGIDA)
// ==========================================

start: class_decl* procedure*

// --- CLASES ---
class_decl: "Clase" IDENTIFIER "{" attribute_list "}"
attribute_list: IDENTIFIER*

// --- PROCEDIMIENTOS ---
procedure: "PROCEDURE" IDENTIFIER "(" param_list? ")" block

// --- PARÃMETROS ---
param_list: param ("," param)*
param: (type_spec)? IDENTIFIER
type_spec: "Clase" | "int" | "float" | "list"

// --- BLOQUE ---
block: "BEGIN" stmt_list "END"

stmt_list: statement*

statement: assign_stmt ";"
         | if_stmt
         | for_stmt
         | while_stmt
         | repeat_stmt
         | return_stmt ";"
         | call_stmt ";"
         | var_decl ";"

// --- VARIABLES LOCALES ---
var_decl: "Clase" IDENTIFIER  -> object_decl
        | type_spec IDENTIFIER ("[" expr "]")? -> local_decl
        | IDENTIFIER "[" expr "]" -> vector_decl

// --- CONTROL DE FLUJO ---
if_stmt: "IF" condition "THEN" block ("ELSE" block)?
while_stmt: "WHILE" condition "DO" block
for_stmt: "FOR" IDENTIFIER ASSIGN expr "TO" expr "DO" block
repeat_stmt: "REPEAT" stmt_list "UNTIL" condition

// --- ASIGNACIÃ“N ---
assign_stmt: lvalue ASSIGN expr

// --- LLAMADAS ---
call_stmt: "CALL" IDENTIFIER "(" arg_list? ")"
return_stmt: "RETURN" expr?

// --- EXPRESIONES ---
expr: logic_or

logic_or: logic_and ("or" logic_and)*
logic_and: comp ("and" comp)*
comp: term (cmp_op term)*

term: factor (add_op factor)*

// --- AQUÃ ESTABA EL ERROR: AHORA ESTÃN SEPARADOS ---
factor: unary (mul_op unary)*

unary: ("-" | "not") unary | atom

atom: NUMBER
    | call_expr
    | array_access
    | lvalue
    | "(" expr ")"
    | length_func
    | "NULL" -> null_val
    | "T" -> true_val
    | "F" -> false_val

// --- ACCESO A DATOS ---
lvalue: IDENTIFIER ("." IDENTIFIER)*

// Soporte para A[i][j] (uno o mÃ¡s Ã­ndices)
array_access: IDENTIFIER ("[" expr (".." expr)? "]")+

length_func: "length" "(" IDENTIFIER ")"
call_expr: IDENTIFIER "(" arg_list? ")"
arg_list: expr ("," expr)*

// --- OPERADORES Y TOKENS ---
!cmp_op: "<" | ">" | "<=" | ">=" | "=" | "<>" | "â‰ " | "â‰¤" | "â‰¥"
!add_op: "+" | "-"
!mul_op: "*" | "/" | "div" | "mod"

condition: expr

ASSIGN: "ðŸ¡¨" | "<-"
IDENTIFIER: /[a-zA-Z_][a-zA-Z0-9_]*/
NUMBER: /\d+(\.\d+)?/
COMMENT: "â–º" /[^\n]*/

%ignore " "
%ignore "\t"
%ignore "\n"
%ignore "\r"
%ignore COMMENT